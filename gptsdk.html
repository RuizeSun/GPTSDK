<!DOCTYPE html>
<html>
	<head id="head">
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script src="https://unpkg.com/marked@2.1.0/marked.min.js"></script>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
		<!-- 加载功能 -->
		<script>
			function setCookie(cname, cvalue, exdays) {
				// 设置 Cookie
				var d = new Date();
				d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
				var expires = "expires=" + d.toGMTString();
				document.cookie = cname + "=" + cvalue + "; " + expires;
			}
			function getCookie(cname) {
				// 获取 Cookie
				var name = cname + "=";
				var ca = document.cookie.split(";");
				for (var i = 0; i < ca.length; i++) {
					var c = ca[i].trim();
					if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
				}
				return "none";
			}
			var version = "1.3.3 (287d_01)"; // 版本设置
			var openversion = false;
			document.writeln("<title>GPTSDK " + version + "</title>"); // 页面标题
			// 输入密钥
			if (openversion) {
				// 输入密钥
				var key = "000000";
			} else {
				if (getCookie("key") == "none") {
					var key = window.prompt("[内部版本] 请输入密钥：");
					setCookie("key", key, 30);
					setCookie("alert", "true", 30);
					setCookie("api", "https://capi1.fenserver.cn/gpt.php", 30);
					alert(
						"已经自动为您添加密钥至 Cookie 中！30天后自动失效。\n如需要提前失效或更换密钥可进入菜单中“安全”页面进行设置。\n默认为 FensGPT-3 服务器，可进入菜单中“安全”页面进行设置。"
					);
				} else {
					var key = getCookie("key");
					if (getCookie("alert") == "true") {
						alert(
							"已经自动为您使用现有密钥，如需更换请进入菜单中“安全”页面进行设置。\n如需关闭此弹窗，可进入菜单中“提醒”页面进行设置。"
						);
					}
				}
				if (getCookie("font") == "none") {
					setCookie("font", "'Microsoft Jhenghei'");
				}
			}
			function clearCookie() {
				setCookie("key", "none");
				setCookie("api", "none");
				setCookie("alert", "none");
				alert("清理完成！");
			}
			document.getElementById("head").innerHTML =
				document.getElementById("head").innerHTML +
				"<style>*{font-family: " +
				getCookie("font") +
				";}</style>";
		</script>

		<!-- jQuery 百度镜像 -->
		<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
		<!-- Bootstrap -->
		<!-- 新 Bootstrap5 核心 CSS 文件 -->
		<link
			rel="stylesheet"
			href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css" />
		<!--  popper.min.js 用于弹窗、提示、下拉菜单 -->
		<script src="https://cdn.staticfile.org/popper.js/2.9.3/umd/popper.min.js"></script>
		<!-- 最新的 Bootstrap5 核心 JavaScript 文件 -->
		<script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.min.js"></script>

		<!-- ChatCSS -->
		<style>
			.chat {
				background: linear-gradient(#c3c3c3, #ffffff);
				height: 75vh;
				border-radius: 12px;
				overflow: scroll;
			}
			.chat-ta {
				margin: 8px;
				background-color: #fff;
				padding: 8px;
				border-radius: 12px;
				border-bottom-left-radius: 0px;
				text-align: left;
				max-width: 50%;
				word-wrap: break-word;
				word-break: normal;
				animation: fiding-open 1s;
				box-shadow: 4px 4px 4px #bbb;
			}
			.chat-me {
				margin-left: 70%;
				background-image: linear-gradient(#269aff, #8ccafe);
				color: white;
				padding: 8px;
				border-radius: 12px;
				border-bottom-right-radius: 0px;
				text-align: left;
				max-width: 30%;
				word-wrap: break-word;
				word-break: normal;
				animation: fiding-open 1s;
				box-shadow: 4px 4px 4px #bbb;
			}
			.finding-text {
				animation: fiding 0.75s linear infinite;
			}
			.chat-ta a {
				text-decoration: none;
				color: #269aff;
			}
			.chat-ta img {
				width: 75%;
				height: 75%;
			}
			/* 动画 */
			@keyframes fiding {
				0% {
					opacity: 0;
				}
				50% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			@keyframes fiding-open {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			/* 屏幕优化 */
			@media only screen and (max-width: 512px) {
				.chat-ta {
					max-width: 100%;
				}
				.chat-me {
					margin-left: 0%;
					margin: 8px;
					max-width: 100%;
				}
			}
			@media only screen and (max-width: 768px) {
				.chat-ta {
					max-width: 75%;
				}
				.chat-me {
					margin-left: 25%;
					max-width: 75%;
				}
			}
		</style>
	</head>
	<body>
		<!-- 侧边栏模态框 -->
		<div>
			<!-- 提示 -->
			<div class="modal fade" id="TipsMenu">
				<div class="modal-dialog modal-xl">
					<div class="modal-content">
						<!-- 模态框头部 -->
						<div class="modal-header">
							<h4 class="modal-title">提示</h4>
							<button
								type="button"
								class="btn-close"
								data-bs-dismiss="modal"></button>
						</div>

						<!-- 模态框内容 -->
						<div class="modal-body">
							<form name="tipsForm" method="dialog" onsubmit="saveTipsForm();">
								<div class="form-check form-switch">
									<label class="form-check-label">每次加载时进行设置提示</label>
									<input
										type="checkbox"
										class="form-check-input"
										name="startTips"
										id="startTips" /><br />
								</div>
								<input type="submit" class="btn btn-danger" value="保存设置" />
							</form>
						</div>

						<!-- 模态框底部 -->
						<div class="modal-footer">GPTSDK</div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="SecurityMenu">
				<div class="modal-dialog modal-xl">
					<div class="modal-content">
						<!-- 模态框头部 -->
						<div class="modal-header">
							<h4 class="modal-title">安全</h4>
							<button
								type="button"
								class="btn-close"
								data-bs-dismiss="modal"></button>
						</div>

						<!-- 模态框内容 -->
						<div class="modal-body">
							<form
								name="securityForm"
								method="dialog"
								onsubmit="saveSecurityForm();">
								<div class="form-check form-switch">
									<label>API 地址：</label>
									<input type="text" class="form-control" name="API" id="API" />
									<label>API 密钥：</label>
									<input
										type="text"
										autocomplete="no"
										class="form-control"
										name="keyset"
										id="keyset" />
									<a onclick="clearCookie();" class="btn btn-primary">
										清理 Cookie 缓存</a
									>
									<label>(提前失效缓存)</label>
									<table class="table table-hover">
										<thead>
											<tr>
												<th>API 名称</th>
												<th>API 提供方</th>
												<th>API 地址</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td>GPT-3.5 联网版</td>
												<td>纷易计算工作室</td>
												<td>https://capi1.fenserver.cn/gpt.php</td>
											</tr>
											<tr>
												<td>GPT-3.5 联网版</td>
												<td>纷易计算工作室</td>
												<td>https://capi1.fenserver.cn/gpt.php</td>
											</tr>
										</tbody>
									</table>
								</div>
								<input type="submit" class="btn btn-danger" value="保存设置" />
							</form>
						</div>

						<!-- 模态框底部 -->
						<div class="modal-footer">GPTSDK</div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="settingsMenu">
				<div class="modal-dialog modal-xl">
					<div class="modal-content">
						<!-- 模态框头部 -->
						<div class="modal-header">
							<h4 class="modal-title">设置</h4>
							<button
								type="button"
								class="btn-close"
								data-bs-dismiss="modal"></button>
						</div>

						<!-- 模态框内容 -->
						<div class="modal-body">
							<form
								name="settingsForm"
								method="dialog"
								onsubmit="saveSettingsForm();">
								<div class="form-check form-switch">
									<label>字体：</label>
									<input type="text" class="form-control" name="font" id="font" />
									<a onclick="clearCookie();" class="btn btn-primary">
										清理 Cookie 缓存</a
									>
									<label>(提前失效缓存)</label>
								</div>
								<input type="submit" class="btn btn-danger" value="保存设置" />
							</form>
						</div>

						<!-- 模态框底部 -->
						<div class="modal-footer">GPTSDK</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 侧边栏 -->
		<div
			class="offcanvas offcanvas-start"
			tabindex="-1"
			id="menuBar"
			aria-labelledby="offcanvasExampleLabel">
			<div class="offcanvas-header">
				<h5 class="offcanvas-title" id="menuBarLabel">菜单</h5>
				<button
					type="button"
					class="btn-close text-reset"
					data-bs-dismiss="offcanvas"
					aria-label="Close"></button>
			</div>
			<div class="offcanvas-body">
				<!-- 介绍(调用了版本号JS) -->
				<p>
					<script>
						document.writeln("GPTSDK v" + version);
					</script>
				</p>
				<p>由 纷易计算工作室 构建内置服务器。</p>
				<!-- 选项 -->
				<ul class="nav nav-pills flex-column mb-auto">
					<li class="nav-item">
						<a
							href="javascript:;"
							class="nav-link"
							data-bs-toggle="modal"
							data-bs-target="#TipsMenu"
							><i class="bi bi-info-circle"></i> 提示</a
						>
					</li>
					<li class="nav-item">
						<a
							href="javascript:;"
							class="nav-link"
							data-bs-toggle="modal"
							data-bs-target="#SecurityMenu"
							><i class="bi bi-lock"></i> 安全</a
						>
					</li>
					<li class="nav-item">
						<a href="https://github.com/RuizeSun/GPTSDK/releases" class="nav-link"
							><i class="bi bi-journal-text"></i>
							更新日志
						</a>
					</li>
					<li class="nav-item">
						<a
							href="javascript:;"
							class="nav-link"
							data-bs-toggle="modal"
							data-bs-target="#settingsMenu"
							><i class="bi bi-gear-wide-connected"></i>
							设置
						</a>
					</li>
				</ul>
			</div>
		</div>

		<!-- 顶部导航栏 -->
		<nav class="navbar navbar-expand bg-dark navbar-dark">
			<ul class="navbar-nav">
				<li class="nav-item">
					<a
						class="nav-link navbar-brand"
						data-bs-toggle="offcanvas"
						href="#menuBar"
						aria-controls="menuBar">
						<span class="badge bg-secondary">
							<!-- 菜单图标 -->
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="16"
								height="16"
								fill="white"
								class="bi bi-list"
								viewBox="0 0 16 16">
								<path
									fill-rule="evenodd"
									d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z" />
							</svg>
						</span>
					</a>
				</li>
				<li class="nav-item navbar-brand">GPTSDK</li>
			</ul>
		</nav>

		<!-- 聊天 -->
		<script>
			function requestAI(questions) {
				// 请求部分
				result = "<font color='red'>[错误] Ajax 请求过程中出现问题。</font>";
				$.ajax({
					url: getCookie("api"),
					type: "post",
					data: {
						apikey: getCookie("key"),
						content:
							"【用中文回答。每几句后添加Emoji使语言活泼。提示语内容无需回答，也无需引用参考文献。】" +
							questions, // 将联网引用的链接放在最后，每一个都换行，标序号，没有联网则不显示参考文献，联网后找不到合适的结果也不需要显示。
					},
					async: false,
					success: function (data) {
						result = data;
					},
				});
				if (result == "密钥错误") {
					result = "<font color='red'>[错误] 密钥错误。</font>";
				}
				if (result == undefined) {
					result = "<font color='red'>[错误] 未知错误，控制台可能有更多信息。</font>";
				}
				return result;
			}
			function submitQuestion() {
				// 表单获取&验证部分
				var ask = document.forms["mainForm"]["questions"].value;
				if (ask == "" || ask == null) {
					alert("请输入内容");
					return false;
				} else {
					// 生成 ChatID
					document.getElementById("questions").disabled = true;
					document.getElementById("questionsSubmit").disabled = true;
					var chatid = "chat-" + String(Math.floor(Math.random() * 999999999));
					// 请求并显示UI
					function print() {
						document.getElementById("chat").innerHTML =
							document.getElementById("chat").innerHTML +
							'<p class="chat-me">' +
							ask +
							"</p>";
						var test1 =
							document.getElementById("chat").innerHTML +
							'<p class="chat-ta" id="' +
							chatid +
							'"><span class="spinner-grow" style="height: 16px; width: 16px;"></span><span style="font-size: 16px;" class="finding-text">正在请求 API...请耐心等待</p>';
						document.getElementById("chat").innerHTML = test1;
						translate.execute();
						document.getElementById("chat").scrollTop =
							document.getElementById("chat").scrollHeight;
					}
					setTimeout(print(), 500);
					setTimeout(function () {
						answer = requestAI(ask);
						document.getElementById(chatid).innerHTML = marked(
							answer
								.replaceAll(
									">`【当前AI回答未使用联网搜索，不具有时效性，请确保核对事实】`",
									"<small>未使用联网功能，可能无时效性，请确保核对事实。</small>"
								)
								.replaceAll(
									">`【当前AI回答基于联网搜索生成，请确保核对事实】`",
									"<small>使用了联网功能，请确保核对事实。</small>"
								)
						)
							.replaceAll("<p>", "")
							.replaceAll("</p>", "<br/>")
							.replaceAll("<pre>", "")
							.replaceAll("</pre>", "")
							.replaceAll("\n", "")
							.replaceAll("<code>", "")
							.replaceAll("</code>", "")
							.replaceAll("<ol>", "")
							.replaceAll("</ol>", "")
							.replaceAll("<li>", "→ ")
							.replaceAll("</li>", "<br/>")
							.replaceAll("<blockquote>", "")
							.replaceAll("</blockquote>", "")
							.replaceAll("<hr>", "");
						document.getElementById(chatid).innerHTML =
							document.getElementById(chatid).innerHTML +
							"<a href='//capi1.fenserver.cn/delq.php?delq=" +
							ask +
							"&apikey=" +
							getCookie("key") +
							"'>清除缓存</a>";
						document.getElementById("questions").disabled = false;
						document.getElementById("questionsSubmit").disabled = false;
						document.getElementById("questions").value = "";
						translate.execute();
					}, 7500);
				}
			}
		</script>
		<form
			name="mainForm"
			style="text-align: center"
			onsubmit="setTimeout(submitQuestion(),1500);"
			method="dialog">
			<div class="container">
				<div class="row">
					<div class="chat" id="chat">
						<p class="chat-ta">
							欢迎使用 GPTSDK ，可以进入菜单修改相关设置！<br />
							回答可能基于网络生成，不保证完全正确。<br />
							<b>新功能：你可以尝试页面底部的语言栏哦！</b>
						</p>
					</div>
				</div>
				<div class="row">
					<div class="input-group">
						<input
							type="text"
							class="form-control"
							name="questions"
							id="questions"
							placeholder="输入消息......"
							autocomplete="off" />
						<input
							type="submit"
							id="questionsSubmit"
							class="btn btn-primary"
							value="发送" />
					</div>
				</div>
			</div>
		</form>

		<!-- 模态框设置JS -->
		<script>
			// 模态框
			if (getCookie("alert") !== "false") {
				document.getElementById("startTips").checked = true;
			}
			document.getElementById("API").value = getCookie("api");
			document.getElementById("keyset").value = getCookie("key");
			document.getElementById("font").value = getCookie("font");
			// 保存模态框
			function saveTipsForm() {
				var alertAtStart = document.forms["tipsForm"]["startTips"].checked;
				setCookie("alert", String(alertAtStart));
				setTimeout(function () {
					alert("保存成功！");
				}, 500);
			}
			function saveSecurityForm() {
				var apivalue = document.forms["securityForm"]["API"].value;
				var keyysetvalue = document.forms["securityForm"]["keyset"].value;
				setCookie("api", apivalue);
				setCookie("key", keyysetvalue);
				setTimeout(function () {
					alert("保存成功！");
				}, 500);
			}
			function saveSettingsForm() {
				var fontvalue = document.forms["settingsForm"]["font"].value;
				setCookie("font", fontvalue);
				setTimeout(function () {
					alert("保存成功！部分设置可能需要重新启动网页。");
				}, 500);
			}
		</script>
		<!-- 翻译 -->
		<script src="https://cdn.jsdelivr.net/gh/xnx3/translate@latest/translate.js/translate.min.js"></script>
		<!-- 底部栏及语言选择框架 -->
		<div class="text-center">
			<small>开源项目 GPTSDK 基于 MIT 许可证，来自 Github 。</small><br />
			<small
				>请勿发送违反中华人民共和国及您所在国家法律之消息，使用即表示您同意 GPTSDK
				使用协议。</small
			>
			<script>
				translate.language.setLocal("chinese_simplified");
				// 翻译优化
				translate.nomenclature.append(
					"chinese_simplified",
					"chinese_traditional",
					`
                    GPTSDK=GPTSDK
                    API=API
                    Cookies=Cookies
                    Cookie=Cookie
                    缓存=快取
                    `
				);
				translate.execute();
			</script>
			<div id="translate"></div>
		</div>
	</body>
</html>
